{% extends 'base.html' %}

{% block title %}Historique des re√ßus{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- ‚úÖ Informations de la boutique -->
  <h4 class="mb-1">{{ current_user.nom_boutique or "Nom de la boutique" }}</h4>
  <p class="mb-0">{{ current_user.adresse_boutique or "Adresse de la boutique" }}</p>
  <p class="mb-2">{{ current_user.telephone_boutique or "T√©l√©phone de la boutique" }}</p>

  {% if not current_user.nom_boutique or not current_user.adresse_boutique or not current_user.telephone_boutique or not current_user.logo %}
    <div class="alert alert-warning mt-3">
      ‚ö†Ô∏è Informations de la boutique incompl√®tes.
      <a href="{{ url_for('modifier_infos_boutique') }}" class="btn btn-sm btn-outline-dark mt-2">Compl√©ter maintenant</a>
    </div>
  {% endif %}

  <h2 class="mt-4">üìú Historique des re√ßus</h2>

  <!-- ‚úÖ Recherche automatique -->
  <input type="text" id="searchInput" class="form-control mb-3 mt-3" placeholder="üîç Rechercher automatiquement...">

  <!-- ‚úÖ Boutons -->
  <a href="{{ url_for('index') }}" class="btn btn-outline-primary mb-3">‚Üê Retour √† l'accueil</a>
  <a href="{{ url_for('voir_corbeille_recus') }}" class="btn btn-outline-danger mb-3 float-end">üóëÔ∏è Corbeille</a>

  <!-- ‚úÖ Table des re√ßus -->
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>R√©f√©rence</th>
          <th>Date</th>
          <th>Montant total</th>
          <th>Infos client</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="recuTableBody">
        {% for recu in recus %}
        <tr>
          <td>{{ recu.reference }}</td>
          <td>{{ recu.date_creation.strftime('%d/%m/%Y %H:%M') }}</td>
          <td>{{ recu.montant_total }} F</td>
          <td>
            {% if recu.nom_client %}
              {{ recu.nom_client }}<br>
              <small>{{ recu.telephone_client }}</small>
            {% else %}
              <em>Non renseign√©</em>
            {% endif %}
          </td>
          <td>
  <a href="{{ url_for('voir_recu', recu_id=recu.id) }}" class="btn btn-primary btn-sm">Voir</a>
  <a href="{{ url_for('modifier_recu', recu_id=recu.id) }}" class="btn btn-warning btn-sm">Modifier</a>

  <!-- Ticket en vert fonc√© -->
  <a href="{{ url_for('recu_ticket', recu_id=recu.id) }}" 
     class="btn btn-success btn-sm" 
     style="background-color:#155724; border-color:#155724;" 
     target="_blank">Ticket</a>

  <!-- Retour en violet -->
  <a href="{{ url_for('effectuer_retour', recu_id=recu.id) }}" 
     class="btn btn-sm" 
     style="background-color:#6f42c1; border-color:#6f42c1; color:#fff;">
     Retour
  </a>

  <form method="POST"
        action="{{ url_for('supprimer_recu_view', recu_id=recu.id) }}"
        class="form-supprimer-recu d-inline"
        data-ref="{{ recu.reference }}">
    <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Supprimer</button>
  </form>
</td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- ‚úÖ SweetAlert confirmation suppression -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.form-supprimer-recu').forEach(form => {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const ref = this.dataset.ref;

        Swal.fire({
          title: '√ätes-vous s√ªr ?',
          text: `Le re√ßu "${ref}" sera d√©plac√© dans la corbeille.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Oui, supprimer',
          cancelButtonText: 'Annuler'
        }).then((result) => {
          if (result.isConfirmed) {
            this.submit();
          }
        });
      });
    });

    // ‚úÖ Recherche AJAX
    const searchInput = document.getElementById('searchInput');
    const tableBody = document.getElementById('recuTableBody');

    searchInput.addEventListener('input', function () {
      const query = this.value.trim();

      fetch(`/recus?q=${encodeURIComponent(query)}`, {
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        tableBody.innerHTML = '';

        if (data.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="5"><em>Aucun re√ßu trouv√©.</em></td></tr>`;
          return;
        }

        data.forEach(recu => {
          const row = `
            <tr>
              <td>${recu.reference}</td>
              <td>${recu.date}</td>
              <td>${recu.montant} F</td>
              <td>${recu.nom_client}<br><small>${recu.tel_client}</small></td>
              <td>
                <a href="/recu/${recu.id}" class="btn btn-primary btn-sm">Voir</a>
                <a href="/recu/${recu.id}/pdf" class="btn btn-secondary btn-sm">PDF</a>
                <a href="/recu/${recu.id}/modifier" class="btn btn-warning btn-sm">Modifier</a>
                <a href="/recu/${recu.id}/retour" class="btn btn-warning btn-sm">Retour</a>
                <form method="POST" action="/recu/${recu.id}/supprimer" class="d-inline">
                  <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è Supprimer</button>
                </form>
              </td>
            </tr>
          `;
          tableBody.insertAdjacentHTML('beforeend', row);
        });
      });
    });
  });
</script>
{% endblock %}
