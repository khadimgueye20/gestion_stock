{% extends 'base.html' %}

{% block title %}Historique des ventes{% endblock %}

{% block content %}
<h2 class="mb-4">Historique des ventes</h2>

<div class="d-flex mb-3"></div>
  <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">
    ‚Üê Retour √† l‚Äôaccueil
 </a>
<a href="{{ url_for('corbeille_ventes') }}" class="btn btn-outline-danger">
  üóë Voir ventes supprim√©es
</a>
</div>

<div class="p-2 rounded shadow mb-3" style="background-color: rgba(255, 255, 255, 0.85); font-size: 0.9rem;">
  <form method="GET" class="row g-2 align-items-end">
    <div class="col-md-4">
      <label for="produit_id" class="form-label fw-semibold text-dark mb-1">Filtrer par produit</label>
      <select class="form-select form-select-sm" name="produit_id" id="produit_id">
        <option value="">Tous les produits</option>
        {% for produit in produits %}
          <option value="{{ produit.id }}" {% if produit.id == produit_id %}selected{% endif %}>{{ produit.nom }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="date_debut" class="form-label fw-semibold text-dark mb-1">Date de d√©but</label>
      <input type="date" class="form-control form-control-sm" name="date_debut" id="date_debut" value="{{ date_debut }}">
    </div>
    <div class="col-md-3">
      <label for="date_fin" class="form-label fw-semibold text-dark mb-1">Date de fin</label>
      <input type="date" class="form-control form-control-sm" name="date_fin" id="date_fin" value="{{ date_fin }}">
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-primary btn-sm w-100">Filtrer</button>
    </div>
  </form>
</div>

{% if ventes %}
  <table class="table table-bordered table-hover text-center">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Produit</th>
        <th>Quantit√©</th>
        <th>Prix unitaire</th>
        <th>Prix total</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for vente in ventes %}
      <tr>
        <td>{{ vente.id }}</td>
        <td>{{ vente.produit.nom }}</td>
        <td>{{ vente.quantite }}</td>
        <td>{{ vente.produit.prix_unitaire }} FCFA</td>
        <td>{{ vente.quantite * vente.produit.prix_unitaire }} FCFA</td>
        <td>{{ vente.date_vente.strftime('%d/%m/%Y %H:%M') }}</td>
        <td>
          <button type="button" class="btn btn-danger btn-sm" onclick="confirmerSuppressionVente({{ vente.id }}, '{{ vente.produit.nom }}')">
  Supprimer
</button>

        </td>
      </tr>
      {% endfor %}

      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function confirmerSuppressionVente(id, produitNom) {
    Swal.fire({
      title: 'Confirmer la suppression',
      text: `Voulez-vous supprimer cette vente de "${produitNom}" ?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Oui, supprimer',
      cancelButtonText: 'Annuler'
    }).then((result) => {
      if (result.isConfirmed) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/supprimer_vente/${id}`;
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>

    </tbody>
  </table>
{% else %}
  <div class="alert alert-info">Aucune vente trouv√©e pour ces crit√®res.</div>
{% endif %}
{% endblock %}
