{% extends 'base.html' %}
{% block title %}Effectuer une vente{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-3">Effectuer une vente</h2>

  <form method="POST" action="{{ url_for('effectuer_vente') }}">
    <!-- Messages flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Barre de recherche -->
    <input type="text" id="searchProduit" class="form-control mb-3"
           placeholder="üîç Rechercher un produit (nom, description, stock)‚Ä¶">

    <!-- Tableau produits -->
    <div class="table-responsive">
      <table class="table table-striped align-middle" id="tableProduits">
        <thead class="table-light">
          <tr>
            <th>Produit</th>
            <th>Description</th>
            <th>Prix de vente</th>
            <th>Prix appliqu√©</th>
            <th>Stock</th>
            <th>Quantit√©</th>
          </tr>
        </thead>
        <tbody>
          {% for produit in produits %}
          <tr>
            <td>{{ produit.nom }}</td>
            <td>{{ produit.description or "‚Äî" }}</td>
            <td>{{ "{:,.0f}".format(produit.prix_vente or 0) }} FCFA</td>
            <td style="max-width: 180px">
              <input type="number"
                     class="form-control form-control-sm prix-produit"
                     name="prix_{{ produit.id }}"
                     step="0.01"
                     min="0"
                     value="{{ produit.prix_vente or 0 }}">
            </td>
            <td>{{ produit.quantite }}</td>
            <td style="max-width: 140px">
              <input type="number"
                     class="form-control form-control-sm quantite-produit"
                     name="quantite_{{ produit.id }}"
                     placeholder="0"
                     min="0"
                     max="{{ produit.quantite }}">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Totaux -->
    <div class="row g-3 mt-2">
      <div class="col-md-6">
        <label class="form-label">Montant total</label>
        <input type="text" class="form-control" id="montant_total_affiche" readonly>
      </div>
      <div class="col-md-6">
        <label for="montant_paye" class="form-label">Montant pay√©</label>
        <input type="number" step="0.01" min="0" class="form-control" id="montant_paye" name="montant_paye" placeholder="0">
        <div id="note_dette" class="form-text" style="display:none;">
          Mode <strong>Dette</strong> : vous pouvez saisir un paiement partiel (ou 0). Le reste sera enregistr√© en dette.
        </div>
      </div>
    </div>

  
    <!-- Infos client -->
    <div class="row g-3 mt-3">
      <div class="col-md-6">
        <label for="nom_client" class="form-label">Nom du client </label>
        <input type="text" class="form-control" id="nom_client" name="nom_client" placeholder="Client">
      </div>
      <div class="col-md-6">
        <label for="telephone_client" class="form-label">T√©l√©phone du client </label>
        <input type="text" class="form-control" id="telephone_client" name="telephone_client" placeholder="77 123 45 67">
      </div>
      <div class="col-md-6">
        <label for="mode_paiement" class="form-label">Mode de paiement</label>
        <select class="form-select" id="mode_paiement" name="mode_paiement" required>
          <option value="" selected disabled>-- S√©lectionner --</option>
          <option value="Especes">Esp√®ce</option>
          <option value="Wave">Wave</option>
          <option value="Orange Money">Orange Money</option>
          <option value="Dette">Dette (cr√©dit)</option>
        </select>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-receipt"></i> Valider la vente
      </button>
      <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Annuler</a>
    </div>
  </form>
</div>

<script>
  const searchInput = document.getElementById("searchProduit");
  const table = document.getElementById("tableProduits");
  const tbody = table.querySelector("tbody");
  const selectMode = document.getElementById("mode_paiement");
  const montantPayeInput = document.getElementById("montant_paye");
  const noteDette = document.getElementById("note_dette");

  searchInput.addEventListener("input", function() {
    const term = this.value.toLowerCase().trim();
    Array.from(tbody.querySelectorAll("tr")).forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(term) ? "" : "none";
    });
  });

  function totalPanier() {
    let total = 0;
    tbody.querySelectorAll("tr").forEach(row => {
      const qte = parseFloat(row.querySelector(".quantite-produit")?.value) || 0;
      const prix = parseFloat(row.querySelector(".prix-produit")?.value) || 0;
      if (qte > 0 && prix >= 0) total += qte * prix;
    });
    return Number(total.toFixed(2));
  }

  function majAffichageTotal() {
    const total = totalPanier();
    document.getElementById("montant_total_affiche").value = total.toLocaleString() + " FCFA";
    const mode = selectMode.value;
    if (mode !== "Dette") {
      montantPayeInput.value = total;
    }
  }

  function onModePaiementChange() {
    if (selectMode.value === "Dette") {
      noteDette.style.display = "block";
    } else {
      noteDette.style.display = "none";
      montantPayeInput.value = totalPanier();
    }
  }

 
  document.querySelectorAll(".quantite-produit, .prix-produit").forEach(input => {
    input.addEventListener("input", majAffichageTotal);
  });
  selectMode.addEventListener("change", onModePaiementChange);

  window.addEventListener("DOMContentLoaded", () => {
    majAffichageTotal();
    onModePaiementChange();
  });
</script>
{% endblock %}